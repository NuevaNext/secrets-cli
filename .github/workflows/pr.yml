name: PR Tests

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Build
        run: make build

      - name: Run E2E Tests
        id: e2e
        run: |
          # Run tests and capture output
          set +e
          OUTPUT=$(./tests/run-tests.sh --rebuild 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Write output to file for comment
          echo "$OUTPUT" > test-results.txt
          
          # Extract summary
          PASSED=$(echo "$OUTPUT" | grep "Passed:" | awk '{print $2}')
          FAILED=$(echo "$OUTPUT" | grep "Failed:" | awk '{print $2}')
          TOTAL=$(echo "$OUTPUT" | grep "Total:" | awk '{print $2}')
          
          echo "passed=${PASSED:-0}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED:-0}" >> $GITHUB_OUTPUT
          echo "total=${TOTAL:-0}" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

      - name: Create Test Results Comment
        if: always() && github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        permissions:
          pull-requests: write
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const passed = '${{ steps.e2e.outputs.passed }}';
            const failed = '${{ steps.e2e.outputs.failed }}';
            const total = '${{ steps.e2e.outputs.total }}';
            const exitCode = '${{ steps.e2e.outputs.exit_code }}';
            
            let output = '';
            try {
              output = fs.readFileSync('test-results.txt', 'utf8');
            } catch (e) {
              output = 'Could not read test output';
            }
            
            // Truncate if too long
            if (output.length > 60000) {
              output = output.substring(output.length - 60000);
            }
            
            const status = exitCode === '0' ? '✅ All tests passed!' : '❌ Some tests failed';
            
            const body = `## Test Results ${status}
            
            | Metric | Count |
            |--------|-------|
            | Total | ${total} |
            | Passed | ${passed} |
            | Failed | ${failed} |
            
            <details>
            <summary>Test Output</summary>
            
            \`\`\`
            ${output}
            \`\`\`
            
            </details>`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('## Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
